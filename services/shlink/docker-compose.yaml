services:
  shlink:
    image: shlinkio/shlink:stable
    restart: unless-stopped
    depends_on:
      - shlink_database
    links:
      - shlink_database
    ports:
      - 8991:8080
    networks:
      - proxy
    environment:
      - TZ="Europe/Berlin"
      - DEFAULT_DOMAIN=localhost:8080
      - IS_HTTPS_ENABLED=false
      - DB_DRIVER=maria
      - DB_USER=shlink
      - DB_NAME=shlink
      - DB_PASSWORD=shlinkpassword
      - DB_HOST=shlink_database
      - SHELL_VERBOSITY=3
      - INITIAL_API_KEY=asdf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink-backend-http.entrypoints=web" # 'web' could be 'http' if also in config file used
      - "traefik.http.routers.shlink-backend-http.rule=Host(`{shlink.fqdn}`)"
      - "traefik.http.middlewares.shlink-backend-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.shlink-backend-https.middlewares=shlink-backend-https-redirect"
      - "traefik.http.routers.shlink-backend-https.entrypoints=websecure" # 'websecure' could be 'https' if also in config file used
      - "traefik.http.routers.shlink-backend-https.rule=Host(`{shlink.fqdn}`)"
      - "traefik.http.routers.shlink-backend-https.tls=true"
      - "traefik.http.routers.shlink-backend-https.tls.certresolver=infomaniak"

  shlink-web-client:
    hostname: shlink-web-client
    image: shlinkio/shlink-web-client:stable
    restart: unless-stopped
    depends_on:
      - shlink
    links:
      - shlink
    ports:
      - 8990:8080
    networks:
      - proxy
    environment:
        TZ: "Europe/Zurich"
        PUID: 1000
        PGID: 1000
        SHLINK_SERVER_URL: http://localhost:8991
        SHLINK_SERVER_API_KEY: asdf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink-ui-http.entrypoints=web" # 'web' could be 'http' if also in config file used
      - "traefik.http.routers.shlink-ui-http.rule=Host(`{shlink.fqdn.ui}`)"
      - "traefik.http.middlewares.shlink-ui-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.shlink-ui-https.middlewares=shlink-ui-https-redirect"
      - "traefik.http.routers.shlink-ui-https.entrypoints=websecure" # 'websecure' could be 'https' if also in config file used
      - "traefik.http.routers.shlink-ui-https.rule=Host(`{shlink.fqdn.ui}`)"
      - "traefik.http.routers.shlink-ui-https.tls=true"
      - "traefik.http.routers.shlink-ui-https.tls.certresolver=infomaniak"
      # - "traefik.http.middlewares.shlink-ui-https.ipwhitelist.sourcerange=${remote.host.ip.or.dyndns}"
      # - "traefik.http.middlewares.shlink-ui-http.ipwhitelist.sourcerange=${remote.host.ip.or.dyndns}"
      # - "traefik.http.routers.shlink-ui-https.middlewares=shlink-ui-https@docker" # important to add the middleware to your router
      # - "traefik.http.routers.shlink-ui-http.middlewares=shlink-ui-http@docker" # important to add the middleware to your router
      # no allow-list on account of accessing from IP-adresses which are not from home

  shlink_database:
    image: mariadb:10.8
    restart: unless-stopped
    environment:
      - MARIADB_ROOT_PASSWORD=rootshlinkpassword
      - MARIADB_DATABASE=shlink
      - MARIADB_USER=shlink
      - MARIADB_PASSWORD=shlinkpassword
    networks:
      - proxy
    volumes:
      - shlink_db:/var/lib/mysql

volumes:
  shlink_db:

networks:
  proxy:
    external: true
