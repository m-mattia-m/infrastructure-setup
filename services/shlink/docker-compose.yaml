# YOU MUST LINK THE `.env`-FILE FOR THIS DOCKER COMPOSE SETUP: 
# `docker compose --env-file .env up -d`
# On account of this reason I decided to replace the environment-variables here during the ansible-instatallation

services:
  shlink:
    image: shlinkio/shlink:stable
    restart: unless-stopped
    depends_on:
      shlink_database:
        condition: service_healthy
    links:
      - shlink_database
    ports:
      - 8991:8080
    networks:
      - proxy
    environment:
      - TZ=Europe/Zurich
      - IS_HTTPS_ENABLED=true
      - DEFAULT_DOMAIN=${SHLINK_SERVER_FQDN}
      - DB_DRIVER=maria
      - DB_USER=${SHLINK_DB_USER}
      - DB_NAME=${SHLINK_DB_NAME}
      - DB_PASSWORD=${SHLINK_DB_PASSWORD}
      - DB_HOST=shlink_database
      - DB_PORT=3308
      - SHELL_VERBOSITY=3
      - INITIAL_API_KEY=${SHLINK_INITIAL_API_KEY}
      - GEOLITE_LICENSE_KEY=${SHLINK_GEOLITE_LICENSE_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink-backend-http.entrypoints=web" # 'web' could be 'http' if also in config file used
      - "traefik.http.routers.shlink-backend-http.rule=Host(`{shlink.fqdn}`)"
      - "traefik.http.middlewares.shlink-backend-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.shlink-backend-https.middlewares=shlink-backend-https-redirect"
      - "traefik.http.routers.shlink-backend-https.entrypoints=websecure" # 'websecure' could be 'https' if also in config file used
      - "traefik.http.routers.shlink-backend-https.rule=Host(`{shlink.fqdn}`)"
      - "traefik.http.routers.shlink-backend-https.tls=true"
      - "traefik.http.routers.shlink-backend-https.tls.certresolver=infomaniak"

  shlink-web-client:
    hostname: shlink-web-client
    image: shlinkio/shlink-web-client:stable
    restart: unless-stopped
    depends_on:
      - shlink
    links:
      - shlink
    ports:
      - 8990:8080
    networks:
      - proxy
    environment:
        TZ: "Europe/Zurich"
        PUID: 1000
        PGID: 1000
        SHLINK_SERVER_URL: ${SHLINK_SERVER_URL}
        SHLINK_SERVER_API_KEY: ${SHLINK_INITIAL_API_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.shlink-ui-http.entrypoints=web" # 'web' could be 'http' if also in config file used
      - "traefik.http.routers.shlink-ui-http.rule=Host(`{shlink.fqdn.ui}`)"
      - "traefik.http.middlewares.shlink-ui-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.shlink-ui-https.middlewares=shlink-ui-https-redirect"
      - "traefik.http.routers.shlink-ui-https.entrypoints=websecure" # 'websecure' could be 'https' if also in config file used
      - "traefik.http.routers.shlink-ui-https.rule=Host(`{shlink.fqdn.ui}`)"
      - "traefik.http.routers.shlink-ui-https.tls=true"
      - "traefik.http.routers.shlink-ui-https.tls.certresolver=infomaniak"
      - "traefik.http.middlewares.shlink-ui-https.ipwhitelist.sourcerange=${remote.host.ip.or.dyndns}"
      - "traefik.http.middlewares.shlink-ui-http.ipwhitelist.sourcerange=${remote.host.ip.or.dyndns}"
      - "traefik.http.routers.shlink-ui-https.middlewares=shlink-ui-https@docker" # important to add the middleware to your router
      - "traefik.http.routers.shlink-ui-http.middlewares=shlink-ui-http@docker" # important to add the middleware to your router
      # no allow-list on account of accessing from IP-adresses which are not from home

  shlink_database:
    image: mariadb:10.8
    restart: unless-stopped
    ports:
      - "3308:3306"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MARIADB_DATABASE=${SHLINK_DB_NAME}
      - MARIADB_USER=${SHLINK_DB_USER}
      - MARIADB_PASSWORD=${SHLINK_DB_PASSWORD}
    networks:
      - proxy
    volumes:
      - shlink_db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "exit | mysql -h localhost -P 3306 -u root -p$${SQL_PASS}" ]
      interval: 5s
      timeout: 1s
      retries: 50

volumes:
  shlink_db:

networks:
  proxy:
    external: true
